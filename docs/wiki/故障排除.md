# 故障排除

<cite>
**本文档中引用的文件**
- [khConfig.py](file://khConfig.py)
- [update_manager.py](file://update_manager.py)
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py)
- [version.py](file://version.py)
</cite>

## 目录
1. [启动失败](#启动失败)
2. [配置错误](#配置错误)
3. [回测异常](#回测异常)
4. [更新失败](#更新失败)

## 启动失败

### 依赖缺失
**现象描述**  
软件启动时弹出错误提示，如“xtquant未安装”或“无法导入模块”，并伴随日志中出现`ImportError`或`ModuleNotFoundError`。

**可能原因**  
- 缺少核心依赖库`xtquant`，该库用于连接miniQMT数据服务。
- Python环境未正确安装或配置所需第三方库。
- 软件打包环境与运行环境不兼容。

**诊断步骤**  
1. 查看启动日志，确认错误信息是否包含`ImportError: No module named 'xtquant'`。
2. 检查`miniQMT_data_parser.py`文件中的导入语句，确认`xtquant.xtdata`是关键依赖。
3. 验证Python环境中是否已安装`xtquant`包。

**解决方案**  
1. 安装`xtquant`依赖：
   ```bash
   pip install xtquant
   ```
2. 若使用独立Python环境，请确保该环境已激活。
3. 重启软件，确认问题是否解决。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L5-L15)

### MiniQMT连接异常
**现象描述**  
软件启动后无法获取实时或历史数据，日志中出现“xtquant不可用，无法解析tick数据”等警告。

**可能原因**  
- miniQMT客户端未启动或未登录。
- `miniQMT_data_parser.py`中数据目录配置错误。
- 网络连接问题导致无法与miniQMT服务通信。

**诊断步骤**  
1. 确认miniQMT客户端已正常运行并成功登录。
2. 检查`miniQMT_data_parser.py`中`data_dir`参数是否指向正确的miniQMT数据目录。
3. 查看日志中是否有`XTDATA_AVAILABLE = False`的记录。

**解决方案**  
1. 启动并登录miniQMT客户端。
2. 在配置文件中正确设置`data_dir`路径。
3. 检查网络连接，确保miniQMT服务可访问。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L10-L20)

## 配置错误

### .kh文件损坏
**现象描述**  
策略文件（`.kh`）无法加载，软件提示“配置文件加载失败”或“JSON解析错误”。

**可能原因**  
- `.kh`文件内容被意外修改，导致JSON格式不合法。
- 文件编码非UTF-8，导致读取异常。
- 文件被部分写入或写入过程中被中断。

**诊断步骤**  
1. 使用文本编辑器打开`.kh`文件，检查是否为合法JSON格式。
2. 查看`khConfig.py`中`_load_config`方法的实现，确认其使用`json.load`进行解析。
3. 检查文件开头是否包含`# coding: utf-8`声明。

**解决方案**  
1. 使用JSON验证工具修复格式错误。
2. 确保文件以UTF-8编码保存。
3. 若无法修复，从备份中恢复文件。

**Section sources**
- [khConfig.py](file://khConfig.py#L40-L50)

### 路径错误
**现象描述**  
软件提示“找不到数据文件”或“路径不存在”，无法加载配置或数据。

**可能原因**  
- `khConfig.py`中`config_path`或`userdata_path`配置的路径不存在。
- 路径包含中文或特殊字符，导致解析失败。
- 相对路径与当前工作目录不匹配。

**诊断步骤**  
1. 检查配置文件中`system.userdata_path`的值。
2. 验证该路径在文件系统中是否存在。
3. 查看日志中是否有`FileNotFoundError`或`No such file or directory`。

**解决方案**  
1. 修改配置文件，确保路径指向有效目录。
2. 避免使用中文或特殊字符作为路径名。
3. 使用绝对路径代替相对路径。

**Section sources**
- [khConfig.py](file://khConfig.py#L15-L25)

## 回测异常

### 数据缺失
**现象描述**  
回测过程中提示“未获取到tick数据”或“K线数据为空”，导致回测中断或结果不准确。

**可能原因**  
- 指定的股票代码或日期范围内无数据。
- `miniQMT_data_parser.py`中`get_local_data`调用失败。
- 数据源服务未响应或返回空结果。

**诊断步骤**  
1. 检查`miniQMT_data_parser.py`中`parse_tick_data`和`parse_kline_data`方法的返回值。
2. 确认`stock_list`配置项中的股票代码格式正确（如`000001.SZ`）。
3. 查看日志中是否有`未获取到tick数据`或`K线数据为空`的警告。

**解决方案**  
1. 确认数据源中存在所需数据。
2. 检查网络连接，确保miniQMT服务正常。
3. 调整回测时间范围或股票列表。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L100-L120)

### 策略报错
**现象描述**  
回测运行时策略抛出异常，日志中出现`ERROR`级别信息，如“计算指标时出现除零错误”。

**可能原因**  
- 策略代码中存在逻辑错误，如除以零、空指针访问。
- 市场数据异常（如价格为0）导致计算失败。
- 使用了未定义的变量或函数。

**诊断步骤**  
1. 查看日志中`ERROR`级别的堆栈信息，定位错误位置。
2. 检查策略代码中涉及数学运算的部分。
3. 验证数据输入是否合法，如价格、成交量是否为正数。

**解决方案**  
1. 在策略中添加异常处理：
   ```python
   try:
       risky_value = 1 / price
   except ZeroDivisionError:
       logging.error("价格为零，无法计算指标")
   ```
2. 对输入数据进行有效性检查。
3. 使用`logging`模块输出调试信息，便于排查。

**Section sources**
- [README.md](file://README.md#L1945-L1975)

## 更新失败

### 更新检查失败
**现象描述**  
点击“检查更新”无响应，或提示“检查更新失败”，日志中出现连接超时或HTTP错误。

**可能原因**  
- 网络连接问题，无法访问更新服务器`https://khsci.com`。
- 服务器端`version.json`文件缺失或格式错误。
- 本地防火墙或代理阻止了请求。

**诊断步骤**  
1. 检查`update_manager.py`中`check_for_updates`方法的请求URL。
2. 查看日志中是否有`ConnectionError`、`Timeout`或`RequestException`。
3. 验证`version.py`中的当前版本号是否正确。

**解决方案**  
1. 检查网络连接，尝试访问`https://khsci.com/khQuant/update/version.json`。
2. 确认服务器端`version.json`文件存在且格式正确。
3. 临时关闭防火墙或配置代理。

**Section sources**
- [update_manager.py](file://update_manager.py#L150-L180)

### 更新下载失败
**现象描述**  
更新下载进度卡住或中断，提示“下载更新文件时出错”。

**可能原因**  
- 下载链接失效或文件不存在。
- 临时目录权限不足，无法写入文件。
- 下载过程中网络中断。

**诊断步骤**  
1. 检查`update_manager.py`中`UpdateDownloadThread`的`url`和`save_path`。
2. 验证临时目录`temp`是否存在且可写。
3. 查看日志中是否有`下载文件无效`或`IOError`。

**解决方案**  
1. 确认`version.json`中的`download_url`或`filename`正确。
2. 以管理员权限运行软件，或更改临时目录路径。
3. 重新尝试下载，或手动从官网下载安装包。

**Section sources**
- [update_manager.py](file://update_manager.py#L250-L280)