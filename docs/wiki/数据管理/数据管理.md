# 数据管理

<cite>
**Referenced Files in This Document**   
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py)
- [miniQMT_data_viewer.py](file://miniQMT_data_viewer.py)
- [khQTTools.py](file://khQTTools.py)
- [GUIScheduler.py](file://GUIScheduler.py)
</cite>

## 目录
1. [数据获取与解析](#数据获取与解析)
2. [数据存储结构](#数据存储结构)
3. [数据浏览功能](#数据浏览功能)
4. [数据查询接口](#数据查询接口)
5. [数据补充任务调度](#数据补充任务调度)
6. [数据完整性与性能优化](#数据完整性与性能优化)

## 数据获取与解析

系统通过 `xtquant` 库从本地 `miniQMT` 客户端获取原始数据。`miniQMT_data_parser.py` 文件中的 `MiniQMTDataParser` 类负责将这些原始数据转换为系统可用的格式。该类支持解析 `tick` 数据和 `K线` 数据。

对于 `tick` 数据，`parse_tick_data` 方法从文件路径中提取股票代码和日期信息，构造完整的股票代码，并使用 `get_local_data` 函数获取数据。数据解析过程中会处理时间格式、提取开高低收等字段，并对买卖盘口数据进行处理，确保数据类型的一致性。

对于 `K线` 数据，`parse_kline_data` 方法同样从文件路径中提取股票代码，构造完整股票代码，并使用 `get_local_data` 函数获取数据。根据返回数据的结构，该方法会调用 `_process_kline_dict_format1` 或 `_process_kline_dict_format2` 方法进行处理，确保数据的正确性和完整性。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L0-L1273)

## 数据存储结构

系统通过 `miniQMT_data_parser.py` 中的 `MiniQMTDataParser` 类解析数据后，数据以结构化的方式存储在本地。`tick` 数据和 `K线` 数据分别存储在不同的目录下，路径结构为 `datadir/交易所代码/周期代码/股票代码/日期.dat`。例如，上交所的 `1m` 数据存储在 `datadir/SH/60/` 目录下，而 `tick` 数据则存储在 `datadir/SH/0/` 目录下。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L0-L1273)

## 数据浏览功能

`miniQMT_data_viewer.py` 文件中的 `MiniQMTDataViewer` 类提供了数据浏览功能。该类通过 `load_data_structure` 方法加载数据结构，构建树形控件，用户可以通过点击树形控件中的节点来浏览不同交易所、不同周期的数据。

`show_period_files` 方法用于显示周期数据文件列表，`show_tick_stock_list` 方法用于显示 `tick` 数据的股票列表，`show_tick_date_files` 方法用于显示 `tick` 数据的日期文件列表。用户可以通过点击表格中的行来加载具体的数据文件，`load_tick_data_file` 和 `load_kline_data_file` 方法会在后台线程中加载数据，并在表格中显示。

**Section sources**
- [miniQMT_data_viewer.py](file://miniQMT_data_viewer.py#L0-L2399)

## 数据查询接口

`khQTTools.py` 文件中的 `khHistory` 函数提供了数据查询接口。该函数允许用户获取指定股票的历史数据，支持多种时间频率和股票范围。参数包括 `symbol_list`（股票代码列表）、`fields`（数据字段列表）、`bar_count`（获取的K线数量）、`fre_step`（时间频率）、`current_time`（当前时间）、`skip_paused`（是否跳过停牌数据）、`fq`（复权方式）和 `force_download`（是否强制下载最新数据）。

**Section sources**
- [khQTTools.py](file://khQTTools.py#L0-L2745)

## 数据补充任务调度

`GUIScheduler.py` 文件中的 `ScheduledSupplementThread` 类负责数据补充任务的调度。该类使用多进程后端来执行数据补充任务，避免了GIL限制。`supplement_data_worker` 函数在独立进程中运行，通过 `supplement_history_data` 函数补充历史行情数据。

`GUIScheduler` 类中的 `execute_supplement` 方法启动数据补充任务，`check_schedule` 方法检查调度任务。用户可以在界面上设置股票池、周期类型、日期范围等参数，然后点击“开始补充”按钮来启动数据补充任务。

**Section sources**
- [GUIScheduler.py](file://GUIScheduler.py#L0-L1854)
- [khQTTools.py](file://khQTTools.py#L0-L2745)

## 数据完整性与性能优化

为了确保数据的完整性，系统在数据补充过程中会检查中断，并在日志中记录详细的进度信息。`supplement_history_data` 函数会检查是否需要中断数据补充过程，并在日志中记录补充数据的详细信息，包括获取的行数、列数和时间跨度。

为了提高性能，系统在数据加载过程中使用了后台线程，避免了阻塞主线程。`DataLoadThread` 类在后台线程中加载数据，并通过信号与主线程通信，确保用户界面的响应性。此外，系统还提供了数据完整性检查和异常处理机制，确保用户能够高效管理本地数据集。

**Section sources**
- [miniQMT_data_parser.py](file://miniQMT_data_parser.py#L0-L1273)
- [miniQMT_data_viewer.py](file://miniQMT_data_viewer.py#L0-L2399)
- [khQTTools.py](file://khQTTools.py#L0-L2745)
- [GUIScheduler.py](file://GUIScheduler.py#L0-L1854)