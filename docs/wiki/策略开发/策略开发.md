
# 策略开发

<cite>
**本文档引用的文件**  
- [strategies\RSI策略.py](file://strategies\RSI策略.py)
- [strategies\双均线多股票_使用MA函数.py](file://strategies\双均线多股票_使用MA函数.py)
- [strategies\双均线多股票_使用khMA函数.py](file://strategies\双均线多股票_使用khMA函数.py)
- [strategies\双均线精简_使用khMA函数.py](file://strategies\双均线精简_使用khMA函数.py)
- [khQuantImport.py](file://khQuantImport.py)
- [MyTT.py](file://MyTT.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [引言](#引言)
2. [策略脚本基本结构](#策略脚本基本结构)
3. [context对象与内置变量](#context对象与内置变量)
4. [khQuantImport.py统一导入接口](#khquantimportpy统一导入接口)
5. [策略示例分析](#策略示例分析)
6. [MyTT.py技术指标实现](#mytt.py技术指标实现)
7. [最佳实践与常见错误](#最佳实践与常见错误)

## 引言

本指南旨在为量化策略开发者提供一套完整的文档体系，涵盖策略编写、调试和运行的各个方面。通过深入解析看海量化交易系统（KHQuant）的核心组件，指导用户掌握策略开发的关键技术，包括context对象的使用、统一导入接口的功能、以及如何利用内置函数和自定义指标构建有效的交易策略。同时，通过分析典型策略示例，阐明不同触发模式下的实现差异，并提供最佳实践建议，帮助开发者规避常见陷阱，提升策略开发效率。

## 策略脚本基本结构

一个标准的KHQuant策略脚本遵循特定的结构规范，确保框架能够正确加载和执行。其核心由两个关键函数构成：`init` 和 `khHandlebar`。

`init` 函数在策略任务启动时被调用一次，用于执行全局初始化操作，如参数设置或数据预加载。该函数接收股票池列表和上下文（context）作为参数，但在此系统中通常无需特殊处理。

`khHandlebar` 函数是策略的核心逻辑所在，根据用户在主界面设置的触发方式（如Tick、K线）被反复调用。该函数接收一个包含当前市场和账户信息的字典（context）作为输入，并返回一个交易信号列表。框架会解析此列表并执行相应的买卖操作。若返回空列表，则表示当前时间点无任何交易行为。

**Section sources**
- [README.md](file://README.md#L1653-L1674)
- [README.md](file://README.md#L1676-L1713)

## context对象与内置变量

`context` 对象是策略与框架之间通信的核心载体，它是一个字典，封装了策略执行所需的所有实时信息。理解其内部结构对于编写有效的策略至关重要。

### 时间信息
所有时间相关的数据都存储在 `context['__current_time__']` 字典中。它提供了多种格式的时间信息，包括Unix时间戳（`timestamp`）、完整的日期时间字符串（`datetime`）、日期（`date`）和时间（`time`）。这些信息可用于实现择时逻辑，例如限制策略仅在特定交易时段内运行。

### 账户信息
账户的资金状况由 `context['__account__']` 字典提供。关键字段包括可用资金（`cash`）、持仓市值（`market_value`）和总资产（`total_asset`）。开发者可以利用这些数据动态计算交易量，例如根据可用资金的一定比例来决定买入数量。

### 持仓信息
当前的持仓详情存储在 `context['__positions__']` 字典中，其结构为 `{股票代码: 持仓详情}`。持仓详情字典包含了每只股票的持仓数量（`volume`）、持仓成本价（`avg_price`）和当前市价（`current_price`）等关键信息。这使得策略能够判断是否已持有某只股票，并据此做出交易决策。

### 行情数据
以股票代码为键，`context` 中直接存储了对应股票在当前时间点的行情数据，通常为一个Pandas Series对象，包含开盘价（`open`）、最高价（`high`）、最低价（`low`）、收盘价（`close`）和成交量（`volume`）等字段。

**Section sources**
- [README.md](file://README.md#L1676-L1713)
- [README.md](file://README.md#L1748-L1778)
- [README.md](file://README.md#L1779-L1816)

## khQuantImport.py统一导入接口

`khQuantImport.py` 模块是策略开发的基石，它提供了一站式的导入功能，通过 `from khQuantImport import *` 语句，即可将策略开发所需的所有常用模块、工具和函数引入当前命名空间，极大地简化了代码的编写。

该模块不仅导入了标准库（如`os`, `sys`）、数据处理库（`numpy`, `pandas`）和量化库（`xtquant`），还整合了项目内部的 `khQTTools` 和 `MyTT` 库。更重要的是，它封装了一系列便捷的类和函数，如 `StrategyContext`、`TimeInfo` 和 `StockDataParser`，为开发者提供了更高层次的抽象。

此外，`khQuantImport.py` 还导出了多个便捷函数，如 `khGet`、`khPrice`、`khHas`、`khBuy` 和 `khSell`。这些函数允许开发者以更简洁的方式访问时间、价格、持仓信息和生成交易信号，避免了直接操作复杂字典结构的繁琐。

**Section sources**
- [khQuantImport.py](file://khQuantImport.py#L1-L521)

## 策略示例分析

通过分析提供的策略示例，可以深入理解不同触发模式和函数的应用场景。

### RSI策略
`RSI策略.py` 展示了如何利用 `MyTT` 库中的 `RSI` 函数进行技术分析。该策略遍历股票池，拉取每只股票的历史收盘价，计算14日RSI指标。当RSI从下方上穿30时买入，从上方下穿70时卖出。此示例清晰地展示了手动获取历史数据并计算指标的完整流程。

### 双均线策略（MA vs khMA）
提供了两个双均线策略的对比：`双均线多股票_使用MA函数.py` 和 `双均线多股票_使用khMA函数.py`。

- **使用MA函数**：此版本需要开发者先调用 `khHistory` 函数手动获取历史收盘价，然后将价格序列传递给 `MyTT` 库的 `MA` 函数来计算均线。这种方式步骤清晰，但代码相对冗长。
- **使用khMA函数**：此版本使用了 `khQTTools` 中的 `khMA` 函数。该函数是一个高级封装，内部集成了行情获取和移动平均计算，开发者只需提供股票代码、周期和截止时间即可直接获得均线值。这极大地简化了代码，体现了高级封装函数在提升开发效率方面的优势。

`双均线精简_使用khMA函数.py