# 策略信号生成

<cite>
**本文档引用的文件**
- [khFrame.py](file://khFrame.py)
- [strategies/双均线精简_使用khMA函数.py](file://strategies/双均线精简_使用khMA函数.py)
- [khQTTools.py](file://khQTTools.py)
- [khTrade.py](file://khTrade.py)
- [khConfig.py](file://khConfig.py)
- [khQuantImport.py](file://khQuantImport.py)
</cite>

## 目录
1. [事件驱动机制与策略调用](#事件驱动机制与策略调用)
2. [行情数据注入与上下文构建](#行情数据注入与上下文构建)
3. [双均线策略信号生成流程](#双均线策略信号生成流程)
4. [时间与行情数据在上下文中的传递](#时间与行情数据在上下文中的传递)
5. [信号生成时机与触发器关系](#信号生成时机与触发器关系)
6. [避免未来函数问题](#避免未来函数问题)
7. [最小可执行策略代码示例](#最小可执行策略代码示例)
8. [常见逻辑错误](#常见逻辑错误)

## 事件驱动机制与策略调用

量化交易框架通过事件驱动机制来调用策略脚本。当市场行情数据更新时，框架的 `on_quote_callback` 回调函数被触发，该函数负责处理接收到的行情数据，并根据配置的触发器决定是否执行策略逻辑。整个流程由 `KhQuantFramework` 类协调，它作为核心框架管理着配置、交易、风险控制和策略模块。

**Section sources**
- [khFrame.py](file://khFrame.py#L644-L808)

## 行情数据注入与上下文构建

在 `on_quote_callback` 函数中，框架首先解析接收到的行情数据，提取时间戳并转换为标准的时间信息字典 `__current_time__`。随后，框架创建一个包含此时间信息的新数据字典 `data_with_time`，并将原始行情数据（如股票代码对应的 `close` 价格）合并进去。接着，框架会根据当前配置的触发器（`TickTrigger`, `KLineTrigger` 等）判断是否应该在此时点触发策略。如果通过触发器检查，框架会将账户信息 (`__account__`)、持仓信息 (`__positions__`)、股票池信息 (`__stock_list__`) 以及框架实例 (`__framework__`) 注入到 `data_with_time` 字典中，最终形成一个完整的策略上下文（context），并将其作为参数传递给策略的 `khHandlebar` 函数。

**Section sources**
- [khFrame.py](file://khFrame.py#L644-L808)

## 双均线策略信号生成流程

以 `strategies/双均线精简_使用khMA函数.py` 策略为例，其信号生成流程如下：策略首先通过 `khGet` 函数从上下文中获取第一只股票代码和当前日期。然后，它调用 `khMA` 函数分别计算该股票的5日和20日收盘价均线。`khMA` 函数内部会调用 `khHistory` 获取指定时间点之前的历史K线数据，并计算移动平均值。策略接着检查当前短周期均线是否上穿长周期均线（金叉）或下穿（死叉），同时结合 `khHas` 函数检查当前持仓情况。当满足金叉且无持仓时，生成买入信号；当满足死叉且有持仓时，生成卖出信号。信号通过 `generate_signal` 函数创建，并返回给框架执行。

**Section sources**
- [strategies/双均线精简_使用khMA函数.py](file://strategies/双均线精简_使用khMA函数.py#L0-L30)
- [khQTTools.py](file://khQTTools.py#L279-L325)
- [khQTTools.py](file://khQTTools.py#L418-L520)
- [khQuantImport.py](file://khQuantImport.py#L283-L423)

## 时间与行情数据在上下文中的传递

`__current_time__` 和股票行情数据是通过 `on_quote_callback` 函数构建的 `data_with_time` 字典传递给策略的。`__current_time__` 字典包含了 `timestamp`、`datetime`、`date` 和 `time` 四个关键字段，它们在行情数据到达时被实时创建。股票行情数据则以股票代码为键，以包含 `open`、`high`、`low`、`close`、`volume` 等字段的 `pandas.Series` 对象为值，直接从原始行情数据中提取并合并到上下文字典中。策略脚本通过 `khGet` 和 `khPrice` 等便捷函数，可以轻松地从这个上下文字典中读取所需的时间和价格信息。

**Section sources**
- [khFrame.py](file://khFrame.py#L644-L808)
- [khQuantImport.py](file://khQuantImport.py#L283-L406)

## 信号生成时机与触发器关系

信号的生成时机完全由触发器（Trigger）决定。框架支持多种触发器：
*   **Tick触发器**: 每当收到一个Tick数据时都触发策略，适用于高频交易。
*   **K线触发器**: 在K线形成时触发，例如 `1m` 触发器在每分钟的开始（秒数为0时）触发，`5m` 触发器在每5分钟的开始（分钟数能被5整除且秒数为0时）触发。
*   **日K线触发器**: 每个交易日触发一次。
*   **自定义定时触发器**: 在用户指定的时间点触发。

策略的执行频率和时机取决于在配置文件中选择的触发器类型。例如，选择 `1m` 触发器意味着策略逻辑每分钟执行一次，这决定了金叉/死叉信号的生成频率。

**Section sources**
- [khFrame.py](file://khFrame.py#L30-L63)
- [khFrame.py](file://khFrame.py#L100-L180)

## 避免未来函数问题

为了避免未来函数问题（即使用了未来数据进行回测），框架在设计上采取了关键措施。`khMA` 函数在计算均线时，其核心是 `khHistory` 函数。`khHistory` 函数在获取历史数据时，会明确指定一个 `current_time` 参数，并且返回的数据**不包含** `current_time` 这个时间点的数据。这意味着，当策略在某个时间点（例如 `2024-01-15 10:00:00`）计算5日均线时，`khHistory` 只会返回该时间点之前的K线数据，从而确保了计算的均线是基于历史数据，而非包含当前或未来数据，从根本上杜绝了未来函数问题。

**Section sources**
- [khQTTools.py](file://khQTTools.py#L2155-L2424)

## 最小可执行策略代码示例

```python
from khQuantImport import *

def init(stocks=None, data=None):
    """策略初始化"""
    pass

def khHandlebar(data: Dict) -> List[Dict]:
    """策略主逻辑"""
    signals = []
    stock_code = khGet(data, "first_stock")
    current_price = khPrice(data, stock_code, "close")
    current_date_str = khGet(data, "date_num")
  
    ma_short = khMA(stock_code, 5, end_time=current_date_str)
    ma_long = khMA(stock_code, 20, end_time=current_date_str)
      
    has_position = khHas(data, stock_code)
  
    if ma_short > ma_long and not has_position:
        signals = generate_signal(data, stock_code, current_price, 1.0, 'buy', f"金叉信号")
    elif ma_short < ma_long and has_position:
        signals = generate_signal(data, stock_code, current_price, 1.0, 'sell', f"死叉信号")

    return signals
```

**Section sources**
- [strategies/双均线精简_使用khMA函数.py](file://strategies/双均线精简_使用khMA函数.py#L0-L30)

## 常见逻辑错误

在编写策略时，常见的逻辑错误包括：
1.  **未处理停牌**: 如果股票停牌，其行情数据（如 `close` 价格）可能为空或不更新。策略在计算均线或生成信号前，应检查数据的有效性，否则可能导致计算错误或异常。
2.  **未处理除权**: 股票除权除息会导致价格出现跳空。如果未使用复权数据（`fq` 参数），计算出的均线会产生偏差，导致错误的交易信号。应确保 `khMA` 函数的 `fq` 参数设置为 `'pre'`（前复权）或 `'post'`（后复权）。
3.  **忽略交易成本**: 在计算最大可买入股数时，未考虑佣金、印花税、过户费等交易成本，可能导致下单时因资金不足而失败。`calculate_max_buy_volume` 函数已内置此逻辑，应正确使用。
4.  **触发器配置不当**: 选择不合适的触发器（如在日线策略中使用Tick触发器）会导致策略执行过于频繁，影响性能或产生错误信号。

**Section sources**
- [khQTTools.py](file://khQTTools.py#L328-L416)
- [khQTTools.py](file://khQTTools.py#L279-L325)