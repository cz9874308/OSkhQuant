
# 回测结果分析与可视化

<cite>
**本文档引用文件**   
- [khFrame.py](file://khFrame.py)
- [backtest_result_window.py](file://backtest_result_window.py)
- [khTrade.py](file://khTrade.py)
- [khConfig.py](file://khConfig.py)
- [khQTTools.py](file://khQTTools.py)
</cite>

## 目录
1. [回测数据的收集与记录](#回测数据的收集与记录)
2. [绩效指标的计算逻辑](#绩效指标的计算逻辑)
3. [结果可视化与图表渲染](#结果可视化与图表渲染)
4. [结果导出与自定义扩展](#结果导出与自定义扩展)
5. [常见可视化异常的调试](#常见可视化异常的调试)

## 回测数据的收集与记录

回测过程中的原始数据收集与记录由 `khFrame.py` 文件中的 `KhQuantFramework` 类负责。该框架在回测运行期间，通过事件驱动的方式，持续记录每日净值、持仓、交易流水等关键信息。

在每个交易信号触发时，`KhTradeManager` 交易管理器会处理 `signals` 信号列表。对于每个买入或卖出信号，系统会精确计算交易成本，包括佣金、印花税、过户费和流量费，并考虑滑点对成交价格的影响。这些详细的交易信息，包括成交时间、证券代码、方向、价格、数量、金额和手续费，会被记录在 `trades` 字典中。

每日的资产和持仓快照通过 `_record_daily_stats` 方法进行记录。该方法在每个交易日结束时被调用，它会将当天的总资产、可用资金、持仓市值和日收益率等数据，以字典形式追加到 `backtest_records` 字典的 `daily_stats` 键下。同时，系统会将基准指数（如沪深300）的收盘价记录在 `benchmark` 键下，用于后续的相对绩效分析。

所有这些原始数据最终都会被 `record_results` 方法持久化到本地文件系统。该方法会创建一个以时间戳命名的回测结果目录，并将 `backtest_records` 字典中的 `daily_stats`、`trades` 和 `benchmark` 数据分别导出为 `daily_stats.csv`、`trades.csv` 和 `benchmark.csv` 文件，为后续的分析和可视化提供数据基础。

**Section sources**
- [khFrame.py](file://khFrame.py#L1000-L1500)
- [khTrade.py](file://khTrade.py#L300-L500)

## 绩效指标的计算逻辑

回测结束后，系统会基于收集到的原始数据计算一系列关键的绩效指标。这些指标的计算主要在 `backtest_result_window.py` 的 `BacktestResultWindow` 类中完成。

核心指标的计算流程如下：
1.  **总收益率与年化收益率**：从 `daily_stats.csv` 中读取初始资金和最终资金，计算总收益率。年化收益率则根据总收益率和回测天数，使用复利公式 `(1 + 总收益率)^(250/年交易天数) - 1` 计算得出。
2.  **最大回撤**：通过计算每日净值相对于历史最高净值的下跌幅度，找出整个回测期间的最大回撤值。这反映了策略可能面临的最大资金损失风险。
3.  **夏普比率**：衡量风险调整后的收益。计算公式为 `(年化收益率 - 无风险收益率) / 年化波动率`。其中，年化波动率是日收益率标准差的年化值（乘以√250）。
4.  **其他指标**：索提诺比率、阿尔法、贝塔等指标也通过类似方式计算。阿尔法和贝塔是通过将策略日收益率与基准日收益率进行线性回归得到的。

这些计算结果会通过 `update_basic_info` 方法更新到结果窗口的“基本信息”面板中，为用户提供对策略表现的全面评估。

**Section sources**
- [backtest_result_window.py](file://backtest_result_window.py#L1000-L1500)

## 结果可视化与图表渲染

`backtest_result_window.py` 文件是回测结果可视化的核心，它利用 `matplotlib` 库在 `PyQt5` 界面中渲染出专业的图表。

### Matplotlib集成方式
系统通过 `FigureCanvasQTAgg` 将 `matplotlib` 的 `Figure` 对象嵌入到 `PyQt5` 的 `QWidget` 中。`create_chart` 方法创建了一个包含四个子图的 `Figure`，并通过 `FigureCanvas` 将其作为 `chart_view` 添加到主界面的布局中。为了确保图表在深色主题下清晰可读，系统设置了 `dark_background` 样式，并自定义了字体和颜色。

### 收益曲线与回撤曲线的绘制
收益曲线和回撤曲线的绘制在 `update_chart` 方法中完成。
1.  **收益曲线**：在主子图 (`self.ax`) 上，使用 `plot` 方法绘制策略净值和基准净值的对比曲线。X轴为日期，Y轴为净值。
2.  **回撤曲线**：在下方的子图 (`self.ax_drawdown`) 上，绘制每日的回撤率。为了更直观地显示风险，该子图的Y轴被反转，使得回撤以向下的柱状图形式呈现。
3.  **盈亏分析图**：在另一个子图上，绘制每日的盈亏金额，帮助用户分析策略的盈利模式。

### 交易标记的叠加显示
交易标记的叠加是通过在 `update_chart` 方法中分析 `trades_df` 交易记录数据框实现的。系统会遍历所有交易记录，根据交易方向（买入/卖出）和时间，在对应的子图上使用 `scatter` 方法绘制不同颜色和形状的散点标记。例如，买入交易用绿色三角形标记，卖出交易用红色倒三角形标记，这些标记会精确地叠加在收益曲线和盈亏分析图上，直观地展示交易决策点。

**Section sources**
- [backtest_result_window.py](file://backtest_result_window.py#L500-L1000)

## 结果导出与自定义扩展

系统