
# 项目简介

<cite>
**Referenced Files in This Document**   
- [README.md](file://README.md)
- [项目文件说明.md](file://项目文件说明.md)
- [GUIkhQuant.py](file://GUIkhQuant.py)
- [khFrame.py](file://khFrame.py)
- [khTrade.py](file://khTrade.py)
- [khRisk.py](file://khRisk.py)
- [khConfig.py](file://khConfig.py)
- [khQTTools.py](file://khQTTools.py)
- [khQuantImport.py](file://khQuantImport.py)
- [MyTT.py](file://MyTT.py)
- [backtest_result_window.py](file://backtest_result_window.py)
- [strategies/双均线多股票_使用khMA函数.py](file://strategies/双均线多股票_使用khMA函数.py)
</cite>

## 目录
1. [项目背景与核心价值](#项目背景与核心价值)
2. [系统整体架构概览](#系统整体架构概览)
3. [核心功能模块详解](#核心功能模块详解)
4. [事件驱动机制与策略执行流程](#事件驱动机制与策略执行流程)
5. [学习路径指引](#学习路径指引)

## 项目背景与核心价值

看海量化交易系统（OSkhQuant）是一款专为A股个人投资者设计的本地化图形化量化交易研究平台。其核心定位是为用户提供一个基于MiniQMT的、集策略回测、数据管理与交易分析于一体的免费、开源、一体化解决方案。

该项目的诞生源于对现有量化工具的深刻反思。作者认为，许多主流工具在策略自由度、数据与策略安全、以及本地化性能方面存在不足。因此，OSkhQuant的设计目标是打破这些“枷锁”，赋予开发者最大的策略实现自由度，同时通过与MiniQMT的深度集成，解决数据源配置的繁琐问题，让用户能够更专注于策略研究本身。

其核心价值体现在以下几个方面：
*   **完全开源免费**：系统源代码完全公开，用户可以自由探索、修改和共建，确保对工具的完全掌控。
*   **数据与策略本地化**：所有策略代码、历史数据、回测结果和交易记录均存储于用户本地计算机，保障了核心资产的安全与隐私。
*   **图形化与代码驱动双引擎**：提供用户友好的PyQt5图形界面（GUI）进行参数配置，同时支持纯粹的Python策略编写，满足从初学者到高级开发者的多层次需求。
*   **深度整合MiniQMT**：直接利用券商提供的成熟、稳定、合规的MiniQMT行情与交易服务，确保数据的可靠性和交易的合规性。
*   **极致策略自由度**：允许在策略中无限制地使用Python生态中的第三方库（如Pandas, NumPy, Scikit-learn, TensorFlow, PyTorch等），为AI和机器学习在量化策略中的应用提供了广阔空间。

**Section sources**
- [README.md](file://README.md#L1-L1000)

## 系统整体架构概览

OSkhQuant采用模块化、低耦合的设计原则，其系统架构清晰地分为多个核心组件，协同工作以实现量化研究的完整闭环。

```mermaid
graph TD
subgraph "GUI主界面"
GUI[GUIkhQuant.py]
Settings[SettingsDialog.py]
DataViewer[GUIDataViewer.py]
Scheduler[GUIScheduler.py]
end
subgraph "核心功能模块"
Frame[khFrame.py<br>核心框架]
Trade[khTrade.py<br>交易管理]
Risk[khRisk.py<br>风险管理]
Tools[khQTTools.py<br>工具集]
Config[khConfig.py<br>配置管理]
end
subgraph "数据与策略"
Data[miniQMT_data_parser.py<br>数据解析]
Strategy[strategies/*.py<br>策略文件]
MyTT[MyTT.py<br>技术指标库]
end
subgraph "外部依赖"
MiniQMT[MiniQMT客户端]
xtquant[xtquant库]
end
GUI --> Frame : "加载配置<br>启动回测"
Frame --> Trade : "执行交易指令"
Frame --> Risk : "进行风控检查"
Frame --> Tools : "获取行情数据"
Frame --> Data : "解析本地数据"
Tools --> MiniQMT : "通过xtquant接口"
Trade --> MiniQMT : "通过xtquant接口"
GUI --> DataViewer : "查看本地数据"
GUI --> Scheduler : "定时补充数据"
Frame --> Strategy : "动态加载并执行"
Strategy --> MyTT : "调用技术指标"
Config --> Frame : "提供配置参数"
```

**Diagram sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1-L100)
- [khFrame.py](file://khFrame.py#L1-L100)
- [khTrade.py](file://khTrade.py#L1-L100)
- [khRisk.py](file://khRisk.py#L1-L100)
- [khQTTools.py](file://khQTTools.py#L1-L100)
- [khConfig.py](file://khConfig.py#L1-L100)
- [项目文件说明.md](file://项目文件说明.md#L1-L200)

**Section sources**
- [项目文件说明.md](file://项目文件说明.md#L1-L200)
- [README.md](file://README.md#L1000-L1500)

## 核心功能模块详解

OSkhQuant的核心功能由一系列精心设计的模块构成，每个模块各司其职，共同支撑起整个平台的运行。

### GUI主界面 (GUIkhQuant.py)
作为系统的门面，`GUIkhQuant.py`是用户与系统交互的中心。它基于PyQt5构建，提供了直观的图形化操作界面。用户可以通过该界面完成所有关键操作，包括：
*   **策略配置**：通过“加载配置”按钮加载`.kh`工程文件，或手动选择策略脚本。
*   **回测设置**：在左侧面板中设置回测时间、基准合约、交易成本（佣金、印花税、滑点等）和股票池。
*   **运行控制**：通过工具栏的“开始运行”和“停止运行”按钮控制回测流程。
*   **信息反馈**：在右侧面板的“系统日志”中实时查看策略运行状态、交易信号、委托与成交回报等详细信息。
*   **结果分析**：回测结束后，点击“打开回测指标”按钮，即可查看由`backtest_result_window.py`生成的详细绩效报告。

### 核心框架 (khFrame.py)
`khFrame.py`是整个系统的“大脑”和“心脏”，负责协调所有模块的运行。其核心功能包括：
*   **事件驱动引擎**：通过`TriggerFactory`创建不同类型的触发器（`TickTrigger`, `KLineTrigger`, `CustomTimeTrigger`），决定策略逻辑`khHandlebar`函数的执行时机。
*   **策略加载与执行**：使用`importlib`动态加载用户编写的策略模块，并在事件触发时调用其`khHandlebar`函数。
*   **数据管理**：通过`xtdata`库与MiniQMT交互，负责批量下载和管理回测所需的历史数据。
*   **交易与风控集成**：初始化并集成`KhTradeManager`和`KhRiskManager`，在策略执行前后进行风控检查和交易处理。

### 交易与风险管理 (khTrade.py & khRisk.py)
*   **交易管理 (khTrade.py)**：`KhTradeManager`类负责处理所有与交易相关的计算和逻辑。它根据配置的交易成本（佣金、印花税、过户费、流量费）和滑点模型，精确计算每笔交易的实际成交价格和总成本。在回测模式下，它会模拟下单、成交、资金和持仓的变化，并通过回调函数将信息反馈给GUI。
*   **风险管理 (khRisk.py)**：`KhRiskManager`类在策略执行前进行风控检查。虽然当前版本的实现较为基础，但其设计为未来扩展更复杂的风控规则（如持仓限制、止损止盈、最大单笔亏损等）提供了清晰的接口。

### 工具与配置 (khQTTools.py & khConfig.py)
*   **工具集 (khQTTools.py)**：这是一个功能强大的工具库，提供了`is_trade_day`（判断交易日）、`khMA`（便捷的均线计算）等常用函数，极大地简化了策略开发。
*   **配置管理 (khConfig.py)**：`KhConfig`类负责解析和管理`.kh`配置文件，将JSON格式的配置信息转换为程序可用的参数，如回测时间、初始资金、股票池等。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1-L1000)
- [khFrame.py](file://khFrame.py#L1-L1000)
- [khTrade.py](file://khTrade.py#L1-L500)
- [khRisk.py](file://khRisk.py#L1-L50)
- [khQTTools.py](file://khQTTools.py#L1-L1000)
- [khConfig.py](file://khConfig.py#L1-L100)

## 事件驱动机制与策略执行流程

OSkhQuant采用事件驱动的编程模型来驱动策略的执行。这一机制是其高效、灵活的核心。整个流程如下：

1.  **事件触发**：系统根据用户在GUI中设置的“触发方式”（如Tick触发、K线触发），由`khFrame.py`中的相应触发器（`TriggerBase`的子类）判断当前时间点是否满足触发条件。
2.  **数据准备**：当触发条件满足时，框架会从MiniQMT获取最新的市场数据，并将这些数据与当前的账户信息（资金、持仓）、时间信息等整合成一个统一的数据字典`data`。
3.  **风控检查**：在调用策略函数前，`KhRiskManager`会对当前的市场数据和账户状态进行检查，如果未通过风控，则跳过本次策略执行。
4.  **策略执行**：框架调用用户策略文件中的`khHandlebar(data)`函数，并将整合好的`data`字典作为参数传入。
5.  **信号生成与处理**：在`khHandlebar`函数中，用户编写策略逻辑。当需要交易时，通过调用`generate_signal`等函数生成交易信号（包含股票代码、买卖方向、价格、数量等信息）。
6.  **交易执行与反馈**：生成的信号列表被传递给`KhTradeManager`。该模块会计算交易成本，模拟执行交易，并更新虚拟账户的资产和持仓