# 第 3 课：第一个回测

> ⏱ **课时**：30 分钟  
> 🎯 **学习目标**：成功运行一次完整的策略回测，并查看回测结果  
> 📚 **难度**：⭐⭐ 入门级

---

## 📖 课程概览

经过前两课的学习，你已经会安装软件、会认识界面了。今天，我们要迈出最关键的一步——**运行你人生中的第一个量化回测！**

这就像学做菜，前面学了认食材、认厨具，今天我们真正开火做一道菜。

> 🎯 **本课目标**  
> 加载示例策略 → 补充数据 → 运行回测 → 查看报告

---

## 3.1 什么是回测？

在正式开始之前，先搞清楚一个概念：**什么是回测（Backtest）？**

### 通俗解释

回测就是 **"时间旅行"**。

想象你发明了一个投资策略，想知道它好不好用。你不可能真的穿越回 2020 年去试试，但你可以：

1. 拿到 2020 年的历史数据
2. 假装你在 2020 年，一天一天往后走
3. 每天都按策略的规则买入或卖出
4. 最后看看赚了多少钱

这就是回测——**用历史数据模拟策略的过往表现**。

### 回测能告诉你什么？

| 问题 | 回测给你的答案 |
|-----|---------------|
| 这个策略能赚钱吗？ | 总收益率 |
| 最坏情况会亏多少？ | 最大回撤 |
| 风险和收益的比例？ | 夏普比率 |
| 一共交易了多少次？ | 交易次数 |

> ⚠️ **重要提醒**  
> 回测赚钱 ≠ 实盘赚钱！过去有效不代表未来有效。但回测是验证策略的第一步。

---

## 3.2 加载示例工程

OSkhQuant 自带了一些示例策略，我们用其中一个来做演示。

### Step 1：找到示例工程

1. 点击工具栏的 **"加载配置"** 按钮
2. 在弹出的对话框中，导航到软件安装目录
3. 找到 `_internal\strategies` 文件夹
4. 选择 `demoMACD.kh` 或类似的示例文件
5. 点击"打开"

> 📍 **示例路径**  
> `C:\Program Files\KhQuant\_internal\strategies\demoMACD.kh`

### Step 2：检查策略文件路径

加载工程后，你可能会发现"策略文件"显示红色或路径不对。这是因为每台电脑的安装路径不同。

**解决方法**：
1. 在左侧面板找到"策略文件"
2. 点击旁边的"浏览"按钮
3. 找到 `strategies` 文件夹
4. 选择 `双均线精简_使用khMA函数.py`

> 💡 **策略文件保存建议**  
> 建议把策略文件复制到用户目录（如 `C:\Users\[用户名]\AppData\Local\KhQuant\strategies\`），避免软件升级时丢失。

---

## 3.3 理解双均线策略

在运行之前，让我们先搞懂这个策略在干什么。

### 策略逻辑

```
如果 5日均线 > 20日均线，而且我没有持仓 → 买入
如果 5日均线 < 20日均线，而且我有持仓 → 卖出
```

### 图解

```
         ⬆️ 股价
         │
    ┌────•────────────────────────
    │   /│\      5日均线
    │  / │ \    /
    │ /  │  \  /
    │/   │   \/     20日均线
────│────│────────────────────────→ 时间
    │    ↑
    │  金叉（上穿）→ 买入信号！
```

- **金叉**：短期均线从下往上穿过长期均线 → 买入
- **死叉**：短期均线从上往下穿过长期均线 → 卖出

这是最经典的技术分析策略之一，简单但有效。

---

## 3.4 配置回测参数

现在让我们配置回测的各项参数。

### 股票池设置

为了演示，我们只回测一只股票。

1. 在左侧面板找到"股票池设置"
2. 勾选"自选清单"
3. 点击旁边的编辑按钮
4. 输入：`002945.SZ,华林证券`
5. 保存

> ⚠️ **免责声明**  
> 教程使用的股票仅为演示目的，不构成投资建议。

### 回测时间设置

1. 找到"开始日期"，设为 `2024-04-03`
2. 找到"结束日期"，设为 `2024-11-01`

### 其他参数

可以保持默认，或根据需要调整：

| 参数 | 建议值 | 说明 |
|-----|-------|------|
| 初始资金 | 100 万 | 回测起始资金 |
| 佣金比例 | 0.00025 | 万分之 2.5，比较常见 |
| 滑点 | 0.001 | 千分之一 |
| 周期类型 | 1分钟 | 策略运行的数据周期 |

---

## 3.5 补充回测数据（最关键的一步！）

**这是新手最容易忽略的步骤！**

回测需要历史数据。如果本地没有数据，策略就没法运行（或者结果不准确）。

### Step 1：打开数据中心

点击工具栏的 **"数据"** 按钮，打开数据中心窗口。

### Step 2：补充分钟数据

1. 在"自选清单"中输入 `002945.SZ,华林证券`
2. 勾选"自选清单"
3. 周期类型勾选 **"1分钟"**
4. 开始日期：`2024-04-03`
5. 结束日期：`2024-11-01`
6. 点击 **"补充数据"** 按钮
7. 等待下载完成

### Step 3：补充日线数据

双均线策略用到了日线数据来计算均线，所以日线数据也要补充。

1. 保持其他设置不变
2. 把周期类型改为 **"1日"**
3. 点击 **"补充数据"** 按钮
4. 等待下载完成

```
✅ 数据补充检查清单：
□ 分钟数据已补充
□ 日线数据已补充
□ 日期范围覆盖回测区间
```

> ⚠️ **没有数据会怎样？**  
> 回测可以启动，但策略拿不到数据，计算会出错，结果不准确。所以一定要先补充数据！

---

## 3.6 开始运行回测！

万事俱备，只欠东风。点击 **"开始运行"** 按钮！

### 观察运行过程

1. **底部状态栏**：显示回测进度（0% → 100%）
2. **右侧日志面板**：滚动显示策略运行信息

```
[INFO] 回测开始: 2024-04-03 至 2024-11-01
[INFO] 股票池加载完成: 1 只股票
[DEBUG] 加载历史数据...
[TRADE] 2024-04-15 买入 002945.SZ 9500股 @10.53
[TRADE] 2024-05-20 卖出 002945.SZ 9500股 @11.28
...
[INFO] 回测运行结束
```

### 回测需要多长时间？

视数据量和策略复杂度而定，通常：
- 单只股票 + 几个月数据 → 几秒到几十秒
- 多只股票 + 一年数据 → 几分钟

---

## 3.7 查看回测报告

回测完成后，报告窗口会自动弹出。

如果不小心关掉了，可以点击右侧面板的 **"打开回测指标"** 按钮。

### 报告包含什么？

#### 1. 核心绩效指标

```
┌─────────────────────────────────────┐
│ 总收益率:        25.3%             │
│ 年化收益率:      42.1%             │
│ 最大回撤:        -12.5%            │
│ 夏普比率:        1.85             │
│ 交易次数:        8 次              │
└─────────────────────────────────────┘
```

**指标解读**：

| 指标 | 含义 | 怎么看 |
|-----|------|-------|
| 总收益率 | 整个回测期间赚了多少 | 越高越好 |
| 最大回撤 | 从最高点跌到最低点的比例 | 越小越好 |
| 夏普比率 | 每承担1单位风险获得的收益 | 大于1算不错 |

#### 2. 资金曲线图

一条折线图，显示你的账户资产如何随时间变化。

理想的曲线是：稳步向上攀升，波动不大。

#### 3. 交易记录表

列出每一笔买卖的详细信息：

| 时间 | 股票 | 方向 | 价格 | 数量 | 盈亏 |
|-----|------|-----|------|-----|-----|
| 2024-04-15 | 002945.SZ | 买入 | 10.53 | 9500 | - |
| 2024-05-20 | 002945.SZ | 卖出 | 11.28 | 9500 | +7125 |

---

## 💡 实践任务

恭喜你完成了第一个回测！现在试试这些任务：

### 任务 1：完整回测
- [ ] 加载示例工程
- [ ] 配置股票池和时间
- [ ] 补充分钟数据和日线数据
- [ ] 运行回测，等待完成
- [ ] 查看回测报告

### 任务 2：修改参数
- [ ] 把初始资金改为 50 万，重新运行
- [ ] 对比两次回测的收益率差异

### 任务 3：换只股票
- [ ] 股票池改为另一只股票（如 `600519.SH,贵州茅台`）
- [ ] 补充新股票的数据
- [ ] 运行回测，看看结果有什么不同

---

## 📚 常见问题

### Q1：回测结果是 0，没有任何交易？

**A**：可能原因：
1. 数据没补充完整（分钟 + 日线都要有）
2. 日期范围没覆盖实际的交易日
3. 股票代码格式不对（要用 `000001.SZ` 这种格式）

### Q2：报告窗口没弹出来？

**A**：点击右侧面板的"打开回测指标"按钮。如果按钮是灰的，说明回测还没完成。

### Q3：回测特别慢？

**A**：
1. 减少股票池的股票数量
2. 缩短回测时间范围
3. 使用日线而不是分钟线

---

## 📌 核心要点总结

今天你学到了：

1. **回测** = 用历史数据模拟策略表现的"时间旅行"
2. **双均线策略**：金叉买、死叉卖
3. **关键步骤**：
   - 加载工程 → 配置参数 → **补充数据** → 运行回测 → 查看报告
4. **数据补充**是最容易忽略但最重要的步骤！
5. **回测报告**包含收益率、最大回撤、夏普比率等核心指标

---

## ➡️ 下一课预告

**第 4 课：核心概念** 💡

你已经成功运行了第一个回测，但策略里面到底写了什么？下一课我们将：
- 深入解读策略代码结构
- 理解 `khHandlebar` 函数的工作原理
- 认识 `data` 字典里都有什么

下一课见！🧠
