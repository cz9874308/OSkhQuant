# 第 7 课：回测分析

> ⏱ **课时**：35 分钟  
> 🎯 **学习目标**：学会解读回测报告，判断策略的真实表现  
> 📚 **难度**：⭐⭐⭐ 进阶入门

---

## 📖 课程概览

恭喜你来到本系列的最后一课！🎉

前面我们学会了写策略、跑回测，但还有一个关键问题：

> "这个策略到底好不好？"

今天我们就来学习如何 **科学地分析回测结果**。

---

## 7.1 回测报告概览

运行完回测后，点击"打开回测指标"，会看到一份详细的报告。

### 报告的主要组成

```
回测报告
├── 核心绩效指标
│   ├── 收益类指标
│   ├── 风险类指标
│   └── 效率类指标
├── 可视化图表
│   ├── 资金曲线
│   └── 回撤曲线
└── 交易明细
    ├── 每笔交易记录
    └── 持仓变化
```

---

## 7.2 核心指标详解

### 收益类指标

#### 总收益率 (Total Return)

**含义**：整个回测期间赚了多少钱（百分比）。

```
总收益率 = (期末资产 - 初始资金) / 初始资金 × 100%
```

**举例**：
- 初始资金 100 万，期末 125 万
- 总收益率 = (125 - 100) / 100 = 25%

**怎么看**：
- 正数 = 赚钱 ✅
- 负数 = 亏钱 ❌
- 要和基准对比才有意义

#### 年化收益率 (Annualized Return)

**含义**：如果按这个速度持续一年，能赚多少。

**为什么需要它**：回测可能只有 3 个月，直接看收益率没法跟别人比。年化之后就有了统一的尺度。

**怎么看**：
- A 股 15%+ 年化算不错
- 大于银行理财就有意义
- 太高要警惕（可能过拟合）

### 风险类指标

#### 最大回撤 (Max Drawdown)

**含义**：从最高点到最低点，最多亏了多少。

```
假设资产走势：100万 → 120万 → 90万 → 110万
最大回撤 = (120 - 90) / 120 = 25%
```

**通俗理解**：你在最倒霉的时候，会亏多少。

**怎么看**：
| 最大回撤 | 评价 |
|---------|------|
| < 10% | 优秀 🌟 |
| 10-20% | 良好 |
| 20-30% | 一般 |
| > 30% | 风险较高 ⚠️ |

> 💡 **重要提醒**  
> 最大回撤比收益率更重要！亏 50% 需要赚 100% 才能回本。

#### 胜率 (Win Rate)

**含义**：盈利交易占总交易的比例。

```
胜率 = 盈利交易次数 / 总交易次数
```

**怎么看**：
- 胜率不是越高越好
- 50% 胜率 + 高盈亏比 = 好策略
- 90% 胜率 + 低盈亏比 = 可能有问题

### 效率类指标

#### 夏普比率 (Sharpe Ratio)

**含义**：每承担 1 单位风险，获得多少收益。

**通俗理解**：性价比。

**怎么看**：
| 夏普比率 | 评价 |
|---------|------|
| < 0 | 差（收益不如无风险利率）|
| 0-1 | 一般 |
| 1-2 | 良好 ✅ |
| > 2 | 优秀 🌟 |

#### 盈亏比 (Profit/Loss Ratio)

**含义**：平均每笔盈利 vs 平均每笔亏损。

```
盈亏比 = 平均盈利金额 / 平均亏损金额
```

**怎么看**：
- 盈亏比 2:1 = 赚一次顶亏两次
- 即使胜率只有 40%，只要盈亏比高，也能赚钱

---

## 7.3 图表解读

### 资金曲线 (Equity Curve)

一条折线图，显示账户资产随时间的变化。

**理想的资金曲线**：

```
    ↑ 资产
    │         ╭───────────
    │      ╭──╯
    │   ╭──╯
    │ ╭─╯
    │─'
    └───────────────────→ 时间
```

- 稳步向上
- 波动平缓
- 没有大的断崖

**不好的资金曲线**：

```
    ↑ 资产
    │  ╭╮
    │ ╭╯ ╲  ╭─╮
    │╭╯    ╲╱   ╲
    │         ╲ ╲
    │              ╲___
    └───────────────────→ 时间
```

- 剧烈波动
- 有大幅回撤
- 后期持续下跌

### 回撤曲线 (Drawdown Curve)

显示每个时点相对历史最高点的回撤幅度。

**怎么看**：
- 红色区域越小越好
- 回撤恢复时间越短越好

---

## 7.4 交易记录分析

每笔交易的详细信息：

| 时间 | 股票 | 方向 | 价格 | 数量 | 盈亏 | 盈亏率 |
|-----|------|-----|------|-----|-----|-------|
| 2024-04-15 | 002945 | 买入 | 10.53 | 9500 | - | - |
| 2024-05-20 | 002945 | 卖出 | 11.28 | 9500 | +7125 | +7.1% |

### 分析要点

1. **交易频率**
   - 交易太频繁 → 手续费吃掉利润
   - 交易太少 → 可能错过机会

2. **盈亏分布**
   - 盈利主要来自少数几笔？（依赖运气）
   - 还是多笔小盈利累积？（稳定可靠）

3. **持仓时间**
   - 平均持仓多久？
   - 和策略设计是否一致？

---

## 7.5 避免回测陷阱

回测结果好看，不代表实盘能赚钱。以下是常见陷阱：

### 1. 过拟合 (Overfitting)

**什么是过拟合**：策略对历史数据"过度学习"，只能解释过去，无法预测未来。

**类比**：考试前把往年试卷背得滚瓜烂熟，但遇到新题就懵了。

**如何识别**：
- 参数非常精确（如 RSI=31.5）
- 回测收益超高（年化 100%+）
- 交易次数很少（不具备统计意义）

**如何避免**：
- 使用"样本外测试"
- 参数保持简单整数
- 增加数据时间跨度

### 2. 未来数据泄露 (Look-Ahead Bias)

**什么是**：在决策时使用了"未来才知道"的信息。

**举例**：
```python
# 错误：使用当天收盘价做买入决策，但买入发生在开盘
if 今天收盘价 > 昨天收盘价:
    以今天开盘价买入  # ❌ 开盘时你还不知道收盘价！
```

**如何避免**：
- 使用 `end_time` 参数限制数据范围
- 买入用开盘价，不用收盘价

### 3. 幸存者偏差 (Survivorship Bias)

**什么是**：只测试了"活下来"的股票，忽略了退市的。

**影响**：回测收益被高估。

**如何处理**：
- 意识到这个问题存在
- 不要只选"明星股"测试
- 多换几只股票验证

### 4. 交易成本低估

**常见问题**：
- 忘记设置滑点
- 佣金设置过低
- 忽略印花税

**真实成本**：
| 项目 | 大约比例 |
|-----|---------|
| 佣金（买+卖） | 0.05% |
| 印花税（仅卖） | 0.1% |
| 滑点 | 0.1-0.2% |
| **单次往返** | **约 0.3-0.4%** |

---

## 7.6 策略评估框架

用这个框架评估你的策略：

```
策略评估清单：

收益性 ✅
├── 年化收益率 > 10%？
├── 跑赢基准（沪深300）？
└── 扣除成本后仍有盈利？

稳定性 ✅
├── 最大回撤 < 20%？
├── 夏普比率 > 1？
└── 资金曲线平滑上升？

可靠性 ✅
├── 交易次数 > 30 次？
├── 参数简单合理？
└── 多只股票都有效？

可行性 ✅
├── 交易频率可接受？
├── 资金容量足够？
└── 符合 T+1 规则？
```

---

## 💡 实践任务

### 任务 1：分析回测报告
- [ ] 运行双均线策略
- [ ] 记录以下指标：
  - 总收益率：_____%
  - 年化收益率：_____%
  - 最大回撤：_____%
  - 夏普比率：_____
  - 交易次数：_____

### 任务 2：指标对比
- [ ] 用不同参数运行同一策略（如 5/20 均线 vs 10/30 均线）
- [ ] 对比两次的指标差异
- [ ] 思考：哪组参数更好？为什么？

### 任务 3：识别问题
- [ ] 故意设置一个极端参数（如 RSI 阈值 29.5）
- [ ] 运行回测
- [ ] 分析：这是否是过拟合？

---

## 📌 核心要点总结

🎓 **恭喜你完成了整个教程系列！**

今天你学到了：

1. **收益类指标**：总收益率、年化收益率
2. **风险类指标**：最大回撤、胜率
3. **效率类指标**：夏普比率、盈亏比
4. **图表解读**：资金曲线、回撤曲线
5. **常见陷阱**：过拟合、未来泄露、幸存者偏差、成本低估
6. **评估框架**：收益性 + 稳定性 + 可靠性 + 可行性

---

## 🎓 课程总结

经过 8 节课的学习，你已经：

| 课程 | 你学会了... |
|-----|------------|
| 第 0 课 | 理解量化交易的本质 |
| 第 1 课 | 搭建完整的运行环境 |
| 第 2 课 | 认识软件界面布局 |
| 第 3 课 | 运行第一个回测 |
| 第 4 课 | 理解策略代码结构 |
| 第 5 课 | 管理历史数据 |
| 第 6 课 | 编写自己的策略 |
| 第 7 课 | 科学分析回测结果 |

---

## 🚀 下一步学习建议

### 初级进阶
- 尝试更多技术指标（MACD、布林带、KDJ）
- 学习仓位管理策略
- 阅读 `strategies` 文件夹里的其他示例

### 中级进阶
- 研究多股票轮动策略
- 学习机器学习选股基础
- 尝试修改 OSkhQuant 源码

### 高级进阶
- 深入研究因子投资
- 学习组合优化方法
- 探索深度学习在量化中的应用

---

## 📚 推荐资源

### 书籍
- 《量化投资策略与技术》
- 《Python for Finance》
- 《机器学习与金融应用》

### 网站
- [看海量化官网](https://khsci.com/khQuant/) - 最新教程和更新
- 聚宽、BigQuant 等平台的学习社区

### 社区交流
- 微信公众号：看海的城堡
- 知乎：@Mr.看海

---

## 🙏 结语

> 量化交易不是魔法，不能保证一夜暴富。
> 
> 但它是一种更科学、更理性的投资方式。
> 
> 希望这套教程能帮助你迈出量化交易的第一步。
> 
> 祝你在量化之路上走得更远！

**感谢你的学习！再见！** 👋

---

> 📝 **作者寄语**  
> 如果这套教程对你有帮助，欢迎 Star ⭐ 项目仓库，或者分享给更多朋友。  
> 投资有风险，入市需谨慎。本教程仅供学习交流，不构成投资建议。
